{% extends "base.html" %}

{% block title %}FDR - Fixture Difficulty Rating - FPL AI Optimizer{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">üèüÔ∏è Fixture Difficulty Rating (FDR)</h1>
        <p class="text-gray-600">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠-‡∏Ç‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</p>
    </div>

    <!-- Filters Section -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- Gameweek Filter -->
            <div>
                <label for="gameweekFilter" class="block text-sm font-medium text-gray-700 mb-2">
                    ‡πÄ‡∏Å‡∏°‡∏ß‡∏µ‡∏Ñ
                </label>
                <select id="gameweekFilter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <!-- Gameweeks 1-38 will be populated -->
                </select>
            </div>

            <!-- Team Filter -->
            <div>
                <label for="teamFilter" class="block text-sm font-medium text-gray-700 mb-2">
                    ‡∏ó‡∏µ‡∏°
                </label>
                <select id="teamFilter" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <!-- Teams will be populated dynamically -->
                </select>
            </div>

            <!-- View Mode -->
            <div>
                <label for="viewMode" class="block text-sm font-medium text-gray-700 mb-2">
                    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                </label>
                <select id="viewMode" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="fixtures">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</option>
                    <option value="matrix">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå FDR</option>
                    <option value="calendar">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</option>
                </select>
            </div>
        </div>

        <div class="flex justify-between items-center">
            <button id="loadDataBtn" 
                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
            
            <!-- FDR Legend -->
            <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-600">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</div>
                <div class="flex space-x-2">
                    <span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">1-2 ‡∏á‡πà‡∏≤‡∏¢</span>
                    <span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">3 ‡∏õ‡∏Å‡∏ï‡∏¥</span>
                    <span class="px-2 py-1 rounded text-xs bg-red-100 text-red-800">4-5 ‡∏¢‡∏≤‡∏Å</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden text-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
        <div class="flex items-center">
            <svg class="h-5 w-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-red-800">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: <span id="errorMessage"></span></span>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="space-y-6">
        <!-- Summary Cards -->
        <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Fixtures Table View -->
        <div id="fixturesView" class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h3>
                <p class="text-sm text-gray-600 mt-1">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡∏∞ FDR ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏π‡πà</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏Å‡∏°‡∏ß‡∏µ‡∏Ñ</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏¢‡πâ‡∏≤</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">FDR</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">VS</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">FDR</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ó‡∏µ‡∏°‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</th>
                        </tr>
                    </thead>
                    <tbody id="fixturesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Fixtures will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- FDR Matrix View -->
        <div id="matrixView" class="hidden bg-white shadow-lg rounded-lg p-6">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå FDR</h3>
                <p class="text-sm text-gray-600 mt-1">‡πÅ‡∏™‡∏î‡∏á FDR ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡∏°‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Å‡∏°‡∏ß‡∏µ‡∏Ñ</p>
            </div>
            <div id="fdrMatrix" class="overflow-x-auto">
                <!-- FDR Matrix will be populated here -->
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView" class="hidden bg-white shadow-lg rounded-lg p-6">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h3>
                <p class="text-sm text-gray-600 mt-1">‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</p>
            </div>
            <div id="calendarContent">
                <!-- Calendar will be populated here -->
            </div>
        </div>
    </div>

    <!-- Default State -->
    <div id="defaultState" class="text-center py-12 bg-gray-50 rounded-lg">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l7 7-7 7z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h3>
        <p class="text-gray-500 mb-4">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡∏∞ FDR</p>
        <button onclick="document.getElementById('loadDataBtn').click()" 
                class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
            ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // State variables
    let currentFixtures = [];
    let allTeams = [];
    
    // DOM elements
    const loadDataBtn = document.getElementById('loadDataBtn');
    const gameweekFilter = document.getElementById('gameweekFilter');
    const teamFilter = document.getElementById('teamFilter');
    const viewModeSelect = document.getElementById('viewMode');
    
    // State elements
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const defaultState = document.getElementById('defaultState');
    const resultsSection = document.getElementById('resultsSection');
    
    // Views
    const fixturesView = document.getElementById('fixturesView');
    const matrixView = document.getElementById('matrixView');
    const calendarView = document.getElementById('calendarView');
    
    // Initialize
    initializeGameweekOptions();
    loadTeams();
    
    // Event listeners
    loadDataBtn.addEventListener('click', loadFixtures);
    viewModeSelect.addEventListener('change', toggleView);
    
    // Initialize gameweek options (1-38)
    function initializeGameweekOptions() {
        const gameweekSelect = document.getElementById('gameweekFilter');
        for (let i = 1; i <= 38; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `‡πÄ‡∏Å‡∏°‡∏ß‡∏µ‡∏Ñ‡∏ó‡∏µ‡πà ${i}`;
            gameweekSelect.appendChild(option);
        }
    }
    
    // Load teams for filter
    async function loadTeams() {
        try {
            const response = await fetch('/api/teams');
            const result = await response.json();
            
            if (result.success) {
                allTeams = result.data;
                const teamSelect = document.getElementById('teamFilter');
                result.data.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.team_id;
                    option.textContent = `${team.name} (${team.short_name})`;
                    teamSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading teams:', error);
        }
    }
    
    // Load fixtures data
    async function loadFixtures() {
        showState('loading');
        
        try {
            const gameweek = gameweekFilter.value || null;
            const teamId = teamFilter.value || null;
            
            const params = new URLSearchParams();
            if (gameweek) params.append('gameweek', gameweek);
            if (teamId) params.append('team_id', teamId);
            params.append('limit', '500');
            
            const response = await fetch(`/api/fixtures?${params.toString()}`);
            const result = await response.json();
            
            if (result.success) {
                currentFixtures = result.data.fixtures;
                renderCurrentView();
                generateSummaryCards();
                showState('results');
            } else {
                throw new Error(result.error || 'Failed to load fixtures');
            }
        } catch (error) {
            console.error('Error loading fixtures:', error);
            document.getElementById('errorMessage').textContent = error.message;
            showState('error');
        }
    }
    
    // Generate summary cards
    function generateSummaryCards() {
        const summaryCards = document.getElementById('summaryCards');
        const totalFixtures = currentFixtures.length;
        const easyFixtures = currentFixtures.filter(f => 
            (f.home_team.difficulty <= 2) || (f.away_team.difficulty <= 2)
        ).length;
        const hardFixtures = currentFixtures.filter(f => 
            (f.home_team.difficulty >= 4) || (f.away_team.difficulty >= 4)
        ).length;
        const avgDifficulty = currentFixtures.length > 0 ? 
            (currentFixtures.reduce((sum, f) => 
                sum + f.home_team.difficulty + f.away_team.difficulty, 0
            ) / (currentFixtures.length * 2)).toFixed(1) : 0;
        
        summaryCards.innerHTML = `
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="text-2xl font-bold text-blue-600">${totalFixtures}</div>
                <div class="text-sm text-gray-600">‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <div class="text-2xl font-bold text-green-600">${easyFixtures}</div>
                <div class="text-sm text-gray-600">‡∏Ñ‡∏π‡πà‡∏á‡πà‡∏≤‡∏¢ (FDR 1-2)</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg">
                <div class="text-2xl font-bold text-red-600">${hardFixtures}</div>
                <div class="text-sm text-gray-600">‡∏Ñ‡∏π‡πà‡∏¢‡∏≤‡∏Å (FDR 4-5)</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
                <div class="text-2xl font-bold text-yellow-600">${avgDifficulty}</div>
                <div class="text-sm text-gray-600">FDR ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
            </div>
        `;
    }
    
    // Render current view based on selection
    function renderCurrentView() {
        const viewMode = viewModeSelect.value;
        
        switch (viewMode) {
            case 'fixtures':
                renderFixturesTable();
                break;
            case 'matrix':
                renderFDRMatrix();
                break;
            case 'calendar':
                renderCalendar();
                break;
        }
    }
    
    // Render fixtures table
    function renderFixturesTable() {
        const tbody = document.getElementById('fixturesTableBody');
        tbody.innerHTML = '';
        
        currentFixtures.forEach(fixture => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    GW${fixture.gameweek}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="font-medium text-gray-900">${fixture.home_team.short_name}</div>
                    <div class="text-xs text-gray-500">${fixture.home_team.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <span class="px-2 py-1 rounded text-xs font-medium ${getDifficultyColor(fixture.home_team.difficulty)}">
                        ${fixture.home_team.difficulty}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-gray-500 font-bold">
                    vs
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <span class="px-2 py-1 rounded text-xs font-medium ${getDifficultyColor(fixture.away_team.difficulty)}">
                        ${fixture.away_team.difficulty}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="font-medium text-gray-900">${fixture.away_team.short_name}</div>
                    <div class="text-xs text-gray-500">${fixture.away_team.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${fixture.kickoff_time ? formatDateTime(fixture.kickoff_time) : 'TBD'}
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // Render FDR Matrix
    function renderFDRMatrix() {
        const fdrMatrix = document.getElementById('fdrMatrix');
        
        if (currentFixtures.length === 0) {
            fdrMatrix.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á</p>';
            return;
        }
        
        // Group fixtures by gameweek
        const fixturesByGW = {};
        currentFixtures.forEach(fixture => {
            if (!fixturesByGW[fixture.gameweek]) {
                fixturesByGW[fixture.gameweek] = [];
            }
            fixturesByGW[fixture.gameweek].push(fixture);
        });
        
        const gameweeks = Object.keys(fixturesByGW).sort((a, b) => a - b);
        
        let html = `
            <table class="min-w-full table-auto border border-gray-200">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ó‡∏µ‡∏°</th>
        `;
        
        gameweeks.forEach(gw => {
            html += `<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">GW${gw}</th>`;
        });
        
        html += '</tr></thead><tbody>';
        
        // Create rows for each team
        allTeams.forEach(team => {
            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium text-gray-900 bg-gray-50">${team.short_name}</td>
            `;
            
            gameweeks.forEach(gw => {
                const teamFixture = fixturesByGW[gw].find(f => 
                    f.home_team.team_id === team.team_id || f.away_team.team_id === team.team_id
                );
                
                if (teamFixture) {
                    const isHome = teamFixture.home_team.team_id === team.team_id;
                    const difficulty = isHome ? teamFixture.home_team.difficulty : teamFixture.away_team.difficulty;
                    const opponent = isHome ? teamFixture.away_team.short_name : teamFixture.home_team.short_name;
                    const venue = isHome ? '(H)' : '(A)';
                    
                    html += `
                        <td class="px-2 py-2 text-center text-xs">
                            <div class="flex flex-col items-center">
                                <span class="px-1 py-1 rounded text-xs font-medium ${getDifficultyColor(difficulty)} mb-1">
                                    ${difficulty}
                                </span>
                                <span class="text-gray-600">${opponent}</span>
                                <span class="text-gray-400">${venue}</span>
                            </div>
                        </td>
                    `;
                } else {
                    html += '<td class="px-2 py-2 text-center">-</td>';
                }
            });
            
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        fdrMatrix.innerHTML = html;
    }
    
    // Calendar state
    let currentCalendarDate = new Date();
    
    // Render Calendar View
    function renderCalendar() {
        const calendarContent = document.getElementById('calendarContent');
        
        if (currentFixtures.length === 0) {
            calendarContent.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á</p>';
            return;
        }
        
        // Group fixtures by date
        const fixturesByDate = {};
        currentFixtures.forEach(fixture => {
            if (fixture.kickoff_time) {
                const date = new Date(fixture.kickoff_time + (fixture.kickoff_time.includes('T') && !fixture.kickoff_time.includes('Z') ? 'Z' : ''));
                const dateKey = date.toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' }); // YYYY-MM-DD format
                
                if (!fixturesByDate[dateKey]) {
                    fixturesByDate[dateKey] = [];
                }
                fixturesByDate[dateKey].push(fixture);
            }
        });
        
        // Get current month/year
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        // Calendar header
        let calendarHTML = `
            <div class="flex justify-between items-center mb-6">
                <button onclick="previousMonth()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    ‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                </button>
                <h3 class="text-xl font-semibold">
                    ${currentCalendarDate.toLocaleDateString('th-TH', { 
                        year: 'numeric', 
                        month: 'long' 
                    })}
                </h3>
                <button onclick="nextMonth()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí
                </button>
            </div>
        `;
        
        // Days of week header
        calendarHTML += `
            <div class="grid grid-cols-7 gap-1 mb-2">
                <div class="p-3 text-center font-medium text-gray-700">‡∏≠‡∏≤</div>
                <div class="p-3 text-center font-medium text-gray-700">‡∏à</div>
                <div class="p-3 text-center font-medium text-gray-700">‡∏≠</div>
                <div class="p-3 text-center font-medium text-gray-700">‡∏û</div>
                <div class="p-3 text-center font-medium text-gray-700">‡∏û‡∏§</div>
                <div class="p-3 text-center font-medium text-gray-700">‡∏®</div>
                <div class="p-3 text-center font-medium text-gray-700">‡∏™</div>
            </div>
        `;
        
        // Calendar grid
        calendarHTML += '<div class="grid grid-cols-7 gap-1 border border-gray-200 rounded-lg overflow-hidden">';
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start from Sunday
        
        // Generate 6 weeks (42 days)
        for (let week = 0; week < 6; week++) {
            for (let day = 0; day < 7; day++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + (week * 7) + day);
                
                const dayKey = currentDay.toLocaleDateString('en-CA');
                const isCurrentMonth = currentDay.getMonth() === month;
                const isToday = currentDay.toDateString() === new Date().toDateString();
                const dayFixtures = fixturesByDate[dayKey] || [];
                
                let cellClass = 'min-h-24 p-1 border-r border-b border-gray-100 bg-white';
                if (!isCurrentMonth) {
                    cellClass += ' bg-gray-50 text-gray-400';
                }
                if (isToday) {
                    cellClass += ' bg-blue-50 border-blue-200';
                }
                
                calendarHTML += `<div class="${cellClass}">`;
                calendarHTML += `<div class="text-sm font-medium mb-1 ${isToday ? 'text-blue-600' : ''}">${currentDay.getDate()}</div>`;
                
                // Add fixtures for this day
                if (dayFixtures.length > 0 && isCurrentMonth) {
                    dayFixtures.forEach(fixture => {
                        const kickoffTime = new Date(fixture.kickoff_time + (fixture.kickoff_time.includes('T') && !fixture.kickoff_time.includes('Z') ? 'Z' : ''));
                        const timeStr = kickoffTime.toLocaleTimeString('th-TH', {
                            hour: '2-digit',
                            minute: '2-digit',
                            timeZone: 'Asia/Bangkok'
                        });
                        
                        const homeColor = getDifficultyColorForCalendar(fixture.home_team.difficulty);
                        const awayColor = getDifficultyColorForCalendar(fixture.away_team.difficulty);
                        
                        calendarHTML += `
                            <div class="text-xs mb-1 p-1 bg-gray-50 rounded border-l-2 border-gray-300">
                                <div class="font-medium text-gray-800">${timeStr}</div>
                                <div class="flex justify-between items-center">
                                    <span class="inline-flex items-center">
                                        <span class="w-2 h-2 rounded-full ${homeColor} mr-1"></span>
                                        ${fixture.home_team.short_name}
                                    </span>
                                    <span class="text-gray-500 mx-1">vs</span>
                                    <span class="inline-flex items-center">
                                        <span class="w-2 h-2 rounded-full ${awayColor} mr-1"></span>
                                        ${fixture.away_team.short_name}
                                    </span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                calendarHTML += '</div>';
            }
        }
        
        calendarHTML += '</div>';
        
        // Legend
        calendarHTML += `
            <div class="mt-4 flex justify-center">
                <div class="flex space-x-4 text-xs">
                    <div class="flex items-center">
                        <span class="w-3 h-3 rounded-full bg-green-500 mr-1"></span>
                        <span>‡∏á‡πà‡∏≤‡∏¢ (1-2)</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 rounded-full bg-yellow-500 mr-1"></span>
                        <span>‡∏õ‡∏Å‡∏ï‡∏¥ (3)</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 rounded-full bg-red-500 mr-1"></span>
                        <span>‡∏¢‡∏≤‡∏Å (4-5)</span>
                    </div>
                </div>
            </div>
        `;
        
        calendarContent.innerHTML = calendarHTML;
    }
    
    // Helper function for calendar difficulty colors
    function getDifficultyColorForCalendar(difficulty) {
        if (difficulty <= 2) return 'bg-green-500';
        if (difficulty === 3) return 'bg-yellow-500';
        return 'bg-red-500';
    }
    
    // Calendar navigation functions
    window.previousMonth = function() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        if (currentFixtures.length > 0) {
            renderCalendar();
        }
    };
    
    window.nextMonth = function() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        if (currentFixtures.length > 0) {
            renderCalendar();
        }
    };
    
    // Toggle between different views
    function toggleView() {
        [fixturesView, matrixView, calendarView].forEach(view => {
            view.classList.add('hidden');
        });
        
        const viewMode = viewModeSelect.value;
        switch (viewMode) {
            case 'fixtures':
                fixturesView.classList.remove('hidden');
                break;
            case 'matrix':
                matrixView.classList.remove('hidden');
                break;
            case 'calendar':
                calendarView.classList.remove('hidden');
                break;
        }
        
        if (currentFixtures.length > 0) {
            renderCurrentView();
        }
    }
    
    // Show different states
    function showState(state) {
        [loadingState, errorState, defaultState, resultsSection].forEach(el => {
            el.classList.add('hidden');
        });
        
        switch (state) {
            case 'loading':
                loadingState.classList.remove('hidden');
                break;
            case 'error':
                errorState.classList.remove('hidden');
                break;
            case 'results':
                resultsSection.classList.remove('hidden');
                break;
            default:
                defaultState.classList.remove('hidden');
        }
    }
    
    // Utility functions
    function getDifficultyColor(difficulty) {
        if (difficulty <= 2) return 'bg-green-100 text-green-800';
        if (difficulty === 3) return 'bg-yellow-100 text-yellow-800';
        return 'bg-red-100 text-red-800';
    }
    
    function formatDateTime(dateString) {
        // Parse the time assuming it's UTC (from FPL API)
        const date = new Date(dateString + (dateString.includes('T') && !dateString.includes('Z') ? 'Z' : ''));
        
        return date.toLocaleDateString('th-TH', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Asia/Bangkok'
        });
    }
    
    // Initialize with default state
    showState('default');
});
</script>
{% endblock %}